!function(e){if(!window.applicationCache)return void alert("您当前的浏览器不支持HTML5,请先升级浏览器才能使用该上传插件!");e.fn.imageCrop=function(i,t){e(this).on("load",function(){var a,n,s,o,l=this.width/this.height,d=i/t;l>=d?(n=t,a=i*l,o=0,s=(a-i)/2):(a=i,n=t/l,s=0,o=0),e(this).css({position:"absolute",top:-o+"px",left:-s+"px",width:a+"px",height:n+"px"})})},e.fn.draggable=function(i){var t={handler:null};i=e.extend(t,i);var a=this;e(i.handler).mousedown(function(i){var t=i.pageX-e(a).position().left,n=i.pageY-e(a).position().top;e(document).mousemove(function(i){window.getSelection?window.getSelection().removeAllRanges():document.selection.empty(),e(a).css({top:i.pageY-n+"px",left:i.pageX-t+"px"})})}).mouseup(function(){e(document).unbind("mousemove")})},void 0==Array.prototype.remove&&(Array.prototype.remove=function(e){for(var i=0;i<this.length;i++)if(this[i]==e){this.splice(i,1);break}}),void 0==Array.prototype.uinque&&(Array.prototype.uinque=function(){for(var e,i=[],t={},a=0;null!=(e=this[a]);a++)t[e]||(i.push(e),t[e]=!0);return i});var i=document.scripts,t=i[i.length-1],a=t.src,n=a.substring(0,a.lastIndexOf("/")+1)+"css/bupload.css";e("head:eq(0)").append('<link href="'+n+'" rel="stylesheet" type="text/css" />'),window.BUpload=function(i){function t(){var t=new s;t.append('<div class="uedbody"><div class="ued_title">'),t.append('<div class="uedbar"><span>多图上传</span></div><div class="close_btn icon" title="关闭对话框"></div>'),t.append('</div><div class="wrapper"><div id="wra_head" class="wra_head"><span class="tab tab-upload focus" tab="upload-panel">本地上传</span>'),null!=i.list_url&&t.append('<span class="tab tab-online" tab="online">文件服务器</span>'),null!=i.search_url&&t.append('<span class="tab tab-search" tab="searchbox">图片搜索</span>'),t.append('</div><div class="wra_body"><div class="tab-panel upload-panel"><div class="wra_pla"><div class="upload-image-placeholder">'),t.append('<div class="btn btn-primary image-select">点击选择图片</div><input type="file" name="'+i.src+'" class="webuploader-element-invisible" multiple="multiple" accept="'+m()+'">'),t.append('</div></div><div class="image-list-box" style="display: none;"><div class="wra_bar"><div class="info fl"></div>'),t.append('<div class="fr"><span class="btn btn-default btn-continue-add">继续添加</span><span class="btn btn-primary btn-start-upload">开始上传</span></div></div>'),t.append('<ul class="filelist"></ul></div></div><div class="tab-panel online"><div class="imagelist"><ul class="list clearfix"></ul><div class="no-data"></div></div></div>'),t.append('<div class="tab-panel searchbox"><div class="search-bar"><input class="searTxt" type="text" placeholder="请输入搜索关键词" />'),t.append('<input value="搜索一下" class="btn btn-primary btn-search" type="button" /><input value="清空搜索" class="btn btn-default btn-reset" type="button" />'),t.append('</div><div class="search-imagelist-box"><ul class="search-list"></ul><div class="no-data"></div></div>'),t.append('</div><div class="loading-icon"></div></div><!-- end of wrapper --></div><div class="wra-btn-group"><span class="btn btn-primary btn-confirm">确认</span>'),t.append('<span class="btn btn-default btn-cancel">取消</span></div></div>'),L.dialog=e(t.toString()),e("body").append(L.dialog),L.dialog.css({left:(e(window).width()-L.dialog.width())/2+"px",top:i.top+"px"}),L.dialog.draggable({handler:L.dialog.find(".ued_title")})}function a(){h(".tab").on("click",function(){var i=e(this).attr("tab");h(".tab-panel").hide(),h("."+i).show(),h(".tab").removeClass("focus"),e(this).addClass("focus")}),h(".close_btn").on("click",function(){L.close()}),h(".webuploader-element-invisible").on("change",function(){n(this)}),h(".image-select").on("click",function(){h(".webuploader-element-invisible").trigger("click")}),h(".btn-continue-add").on("click",function(){h(".webuploader-element-invisible").trigger("click")}),h(".btn-start-upload").on("click",function(){if(!L.uploadLock){if(0==L.todoList.length)return alert("请至少添加一个文件！"),!1;e(this).addClass("disabled").text("正在上传"),o(L.todoList.shift())}}),h(".btn-confirm").on("click",function(){if(L.todoList.length>0)return alert("您还有文件没有上传!"),!1;if(0==L.selectedList.length)return L.close(),!1;if(null==i.grap_url)return alert("抓取网络图片失败，请设置抓取图片的后端地址."),void L.close();if(L.searchList.length>0){var t=e('<span class="loading-message">正在抓取网络图片……</span>');h(".loading-icon").show().html(t),e.get(i.grap_url,{act:"grapImage",urls:encodeURI(L.searchList.join(","))},function(t){"000"!=t.code?i.errorHandler(t.message,"error"):(e.each(L.searchList,function(e,i){L.selectedList.remove(i)}),e.each(t.items,function(e,i){L.selectedList.push(i)}),i.callback(L.selectedList),L.close()),h(".loading-icon").hide().empty()},"json")}else i.callback(L.selectedList),L.close()}),h(".btn-cancel").on("click",function(){L.close()}),h(".tab-online").on("click",function(){0==h(".imagelist .list").children().length&&g()}),h(".imagelist").on("scroll",function(){this.scrollTop+this.clientHeight>=this.scrollHeight&&g()}),h(".search-imagelist-box").on("scroll",function(){this.scrollTop+this.clientHeight>=this.scrollHeight&&v()}),h(".btn-search").on("click",function(){var e=h(".searTxt").val().trim();return""==e?(h(".searchbox .no-data").html('<span class="error">请输入搜索关键字.</span>').show(),h(".searTxt").focus(),!1):(L.searchText=e,L.searchPage=1,h(".search-imagelist-box").find(".search-list").empty(),void v())}),h(".btn-reset").on("click",function(){h(".searTxt").val("")})}function n(t){for(var a=t.files,n=L.todoList.length+L.uploadSuccessNum+a.length,o=L.addedFileNumber;o<L.addedFileNumber+a.length;o++){if(n>i.max_filenum)return void alert("您本次最多上传"+i.max_filenum+"个文件.");var l=new s,d=a[o-L.addedFileNumber];l.append('<li id="img-comtainer-'+_+o+'"><div class="imgWrap">');var p=u(d.name);""==p&&(p="default"),p=p.toLowerCase(),-1=="jpg|jpeg|gif|png|bmp".indexOf(p)?l.append('<span class="icon-placeholder icon-'+p+'"></span>'):l.append('<img src="'+window.URL.createObjectURL(d)+'" border="0" />'),l.append('</div><div class="file-opt-box clearfix"><span class="remove" index="'+o+'">删除</span><span class="rotateRight">向右旋转</span>'),l.append('<span class="rotateLeft">向左旋转</span></div><div class="success"></div><div class="error"></div>'),l.append('<div class="progress"><span style="display: none; width: 0px;"></span></div></li>');var r=e(l.toString());r.find(".remove").on("click",function(){e(this).parents("li").remove();for(var i=e(this).attr("index"),t=0;t<L.todoList.length;t++)if(L.todoList[t].index==i){L.totalFilesize-=L.todoList[t].file.size,c(L.uploadSuccessNum+L.todoList.length-1,L.totalFilesize),L.todoList.splice(t,1);break}0==h(".filelist li").length&&(h(".image-list-box").hide(),h(".wra_pla").show())}),r.on("mouseover",function(){e(this).find(".file-opt-box").show()}).on("mouseout",function(){e(this).find(".file-opt-box").hide()}),h(".wra_pla").hide(),h(".image-list-box").show(),h(".filelist").append(r),L.todoList.push({index:o,file:d}),L.totalFilesize+=d.size}L.addedFileNumber+=a.length,c(L.uploadSuccessNum+L.todoList.length,L.totalFilesize),e(".imgWrap img").imageCrop(113,113)}function o(t){if(!r(t))return void l();var a=new XMLHttpRequest;a.open("POST",i.upload_url),a.addEventListener("load",function(a){if("json"==i.data_type){var n=e.parseJSON(a.target.responseText);"000"==n.code?(L.selectedList.push(n.item),L.uploadSuccessNum++,e("#img-comtainer-"+_+t.index).find(".file-opt-box").remove(),e("#img-comtainer-"+_+t.index).find(".progress").remove(),e("#img-comtainer-"+_+t.index).find(".success").show()):f(b[n.code],t)}},!1),a.addEventListener("loadend",function(){l()},!1),a.addEventListener("error",function(){f("发生异常，上传失败!",t)},!1),a.upload.addEventListener("progress",function(e){d(e,t)},!1);var n=new FormData;n.append(i.src,t.file),a.send(n)}function l(){if(L.todoList.length){var e=L.todoList.shift();o(e)}else L.uploadLock=!1,h(".btn-start-upload").removeClass("disabled").text("开始上传")}function d(i,t){i.lengthComputable&&e("#img-comtainer-"+_+t.index).find(".progress span").css({width:i.loaded/i.total*100+"%",display:"block"})}function c(e,t){h(".info").text("共选择了 "+e+" 张图片，共 "+p(t)+", 还可以添加 "+(i.max_filenum-e)+" 张图片.")}function p(e){return e/1048576>1?(e/1048576).toFixed(2)+"MB":(e/1024).toFixed(2)+"KB"}function r(e){var t=1024*i.max_filesize;if(t>0&&e.file.size>t)return f("文件大小不能超过 "+i.max_filesize+" KB",e),!1;var a=u(e.file.name);return a&&-1!=i.ext_allow.indexOf(a)&&-1==i.ext_refuse.indexOf(a)?!0:(f("非法的文件后缀 "+a,e),!1)}function u(e){if(!e)return!1;var i=e.lastIndexOf(".");return-1!=i?e.substr(i+1).toLowerCase():!1}function m(){var t=i.ext_allow.split("|"),a=[];return e.each(t,function(e,i){a.push(w[i])}),a.length>1?a.uinque().join(","):"*"}function f(e,i){h("#img-comtainer-"+_+i.index).find(".error").show().text(e)}function h(e){return L.dialog.find(e)}function g(){return null==i.list_url?(h(".online .no-data").html('<span class="error">无法获取图片，请先配置 list_url.</span>').show(),!1):L.noRecord?!1:(h(".loading-icon").show(),void e.get(i.list_url,{page:L.page},function(e){h(".loading-icon").hide(),"000"==e.code?(L.page++,x(e.items,"online")):(h(".online .no-data").text(i.no_data_text).show(),L.noRecord=!0)},"json"))}function v(){return null==i.search_url?(h(".searchbox .no-data").html('<span class="error">无法进行图片搜索，请先配置 search_url.</span>').show(),!1):(h(".loading-icon").show(),void e.get(i.search_url,{page:L.searchPage,kw:L.searchText},function(e){h(".loading-icon").hide(),"000"==e.code?(h(".searchbox .no-data").hide(),L.searchPage++,x(e.items,"search")):h(".no-data").text(i.no_data_text).show()},"json"))}function x(i,t){e.each(i,function(i,a){var n=new s;n.append("<li>");var o=u(a.thumbURL);""==o&&(o="default"),o=o.toLowerCase(),-1=="jpg|jpeg|gif|png|bmp".indexOf(o)?n.append('<span class="icon-placeholder icon-'+o+'" data-src="'+a.oriURL+'"></span>'):n.append('<img src="'+a.thumbURL+'" data-src="'+a.oriURL+'" border="0">'),n.append('<span class="ic" data-module="'+t+'"><em class="img-size">'+a.width+"x"+a.height+"</em></span></li>");var l=e(n.toString());l.find(".ic").on("click",function(){var i=e(this).prev().data("src"),t=e(this).data("module");e(this).hasClass("selected")?(e(this).removeClass("selected"),L.selectedList.remove(i),"search"==t&&L.searchList.remove(i)):(e(this).addClass("selected"),L.selectedList.push(i),"search"==t&&L.searchList.push(i))}),l.find("img").imageCrop(113,113),"online"==t?h(".imagelist .list").append(l):"search"==t&&h(".search-imagelist-box .search-list").append(l)})}i=e.extend({src:"src",upload_url:null,list_url:null,grap_url:null,search_url:null,data_type:"json",top:50,max_filesize:2048,max_filenum:20,no_data_text:"(⊙o⊙)亲，没有多数据了。",ext_allow:"jpg|png|gif|jpeg",ext_refuse:"exe|txt",callback:function(e){console.log(e)}},i);var b={"000":"文件上传成功","001":"文件上传失败","002":"文件大小超出限制","003":"非法文件名后缀"},w={"3gpp":"audio/3gpp, video/3gpp",ac3:"audio/ac3",asf:"allpication/vnd.ms-asf",au:"audio/basic",css:"text/css",csv:"text/csv",doc:"application/msword",dot:"application/msword",dtd:"application/xml-dtd",dwg:"image/vnd.dwg",dxf:"image/vnd.dxf",gif:"image/gif",htm:"text/html",html:"text/html",jp2:"image/jp2",jpe:"image/jpeg",jpeg:"image/jpeg",jpg:"image/jpeg",js:"text/javascript, application/javascript",json:"application/json",mp2:"audio/mpeg, video/mpeg",mp3:"audio/mpeg",mp4:"audio/mp4, video/mp4",mpeg:"video/mpeg",mpg:"video/mpeg",mpp:"application/vnd.ms-project",ogg:"application/ogg, audio/ogg",pdf:"application/pdf",png:"image/png",pot:"application/vnd.ms-powerpoint",pps:"application/vnd.ms-powerpoint",ppt:"application/vnd.ms-powerpoint",rtf:"application/rtf, text/rtf",svf:"image/vnd.svf",tif:"image/tiff",tiff:"image/tiff",txt:"text/plain",wdb:"application/vnd.ms-works",wps:"application/vnd.ms-works",xhtml:"application/xhtml+xml",xlc:"application/vnd.ms-excel",xlm:"application/vnd.ms-excel",xls:"application/vnd.ms-excel",xlt:"application/vnd.ms-excel",xlw:"application/vnd.ms-excel",xml:"text/xml, application/xml",zip:"aplication/zip",xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"},L={};L.dialog=null,L.todoList=new Array,L.uploadSuccessNum=0,L.selectedList=[],L.searchList=[],L.addedFileNumber=0,L.totalFilesize=0,L.uploadLock=!1,L.page=1,L.searchPage=1,L.searchText=null,L.noRecord=!1;var _=Math.ceil(1e12*Math.random());return L.close=function(){L.dialog.remove();try{JDialog.lock.hide()}catch(e){}},t(),a(),L};var s=function(){var e=new Array;s.prototype.append=function(i){e.push(i)},s.prototype.toString=function(){return e.join("")}}}(jQuery);